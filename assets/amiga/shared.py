from PIL import Image,ImageOps
import os,sys,bitplanelib,subprocess,json,pathlib

this_dir = pathlib.Path(__file__).absolute().parent

data_dir = this_dir / ".." / ".."
src_dir = this_dir / ".." / ".." / "src" / "amiga"
aga_src_dir = src_dir / "aga"
ocs_src_dir = src_dir / "ocs"

#aga_src_dir.mkdir(exist_ok=True)
#ocs_src_dir.mkdir(exist_ok=True)
sheets_path = this_dir / ".." / "sheets"
dump_dir = this_dir / "dumps"

used_sprite_cluts_file = this_dir / "used_sprite_cluts.json"
used_tile_cluts_file = this_dir / "used_tile_cluts.json"
used_graphics_dir = this_dir / "used_graphics"

NB_SPRITES = 0x200
NB_TILES = 0x400


def palette_pad(palette,pad_nb):
    palette += (pad_nb-len(palette)) * [(0x10,0x20,0x30)]

def ensure_empty(d):
    if os.path.exists(d):
        for f in os.listdir(d):
            x = os.path.join(d,f)
            if os.path.isfile(x):
                os.remove(x)
    else:
        os.makedirs(d)

def ensure_exists(d):
    if os.path.exists(d):
        pass
    else:
        os.makedirs(d)

sr2 = lambda a,b : set(range(a,b,2))

player_sprite_pairs = (sr2(0x0,0x18) |
{0X44,0x1E,0x1B4,0x1BC,0x34,0x3A,0x32,0x36,0x3E,0x4C,0x5A,0x3C,0x1B6,0x1BE,0x4A,0x5E,0X42,0x56,0xb1,0xac,0xA4,0x11E,0xa2,0xB4,0xBE,0x11c,0x1B0,0x193,0x152,0x1A,0x8A,0x1B2,0x1c,0x14A,0x17E,0x1B8,0x1BA,0X150,0x188,0x180,0x111,
0x50,0x54,0x58,0x88,0x176,0X120,0x124,0x128,0x130,0x134,0x138,0x140,0x142,0x148,0x1F0,0x1F8,0x1FA,0x5C,0x13C,0x12C,0x18,0x195,0x10A,0x10D} |
 sr2(0X114,0x11C) | sr2(0x108,0x10C) | sr2(0Xc0,0xE0) |
sr2(0x1E0,0x1E6) | sr2(0x1E8,0x1EE) | # shoot
sr2(0x1AC,0x1B0) |
sr2(0x182,0x186) | sr2(0X18A,0x18E)
)
player_single_sprites = {0x101,
0x102,
0x10f,
0x154,
0x158,
0x159,
0x15a,
0x15b,
0x15c,
0x15d,
0x166,
0x167,
0x186,
0x187,
0x18e,
0x18f,
0x190,
0x191,
0x192,
0x197,
0x198,
0x199,
0x19a,
0x19b,
0x19c,
0x19f,
0x1a0,
0x1a1,
0x1a2,
0x1a3,
0x1a4,
0x1a5,
0x1a6,
0x1ab,
0x1ef,
0x1f3,
0x1f4,
0x81,
0x97,
0x9f,
0xa6,
0xaa,
0xab,
0xae,
0xb0,
0xb3,
0xb6,
0xb8,
0xb9,
0xba,
0xbb,
0xbd,
0xe7,
0x53,
0xed,
0xee,0x9C,0x8C,
0x82,0x83,0x84,0xFE,0xF6,0xFF,0xF7,0xA0,0xA1,
0x94} | set(range(0x70,0x80))

swimming_player = {0x101,
#0x1AC,
#0x1AE,  cpu players don't miss breath
0x102,
0x108,
0x10a,
0x10d,
0x10f,
0x111,
0x114,
0x116,
0x118,
0x11a,
0x11c,
0x11e,
0x166,
0x167,
0x100,
0x103,
0x106,
0x107,
0x110,
0x113,
0x164,
0x165}

girls = set(range(0x1C0,0x1DE))

#0x146,0x14E use a mirror (target): don't regroup!!
group_sprite_pairs = player_sprite_pairs | {0x17C,0x1DE,0xF0,0x8E,0x85,0x17C,0xFC,0x62,0x64,0x66,0x168,0x17A,0x160,0x1A8} |sr2(0x2A,0x30)
shooting_player = {0X1E0,0x1E2,0x1E4,0x1E8,0x1EA,0x1EC,0x1EF,0x1F4,0x1E7,0x1F2,0x1F5}
bow_player = {0xE7,0xEE}
# we gather into "running player" all player frames that aren't in pole vault (where priorities prevent from using HW sprites)
# same for weightlifting
running_player = set(range(0xC0,0xE0,2)) | set(range(0x7A,0x80)) | {0x10,0x12,0x14,0X120,0x124,0X128,0x130,0X134,0X138,0x140,0x142,0x148,0x150,0x152,0x154,0x158,0x159,0x176} | {
0xF6,0xF7,0xFE,0xFF,0x3A,0x3C,0x3E,0x4,0x4A,0x4C,0x54,0x56,0x58,0x5A,0x5C,0x5E,0x6,0X2,0x8A,0x8C,0x9C,0x13C,0x15A,0x15B,
0x15C,0x15D,0x16,0x88,0x73,0x78,0x74,0x75,0x76,0x77,0x1B2,0x1B4,0x1B6,0x1BC,0x1BE,0x1C,0x1E,0x1F8,0x1FA,0x8,0X50,0x70,0x71,0x72,0x79,0x81,0x82,
0x83,0x84,0x94,0x97,0XC,0xE0,0x1A,0,0xA,0xC,0x18,0xE,0X9F,0x1F0,0x1F3,0x1BA,0x14A,0x17E,0x12C,0xA0,0xA1
}
weight_player = {0x180,
0x182,0x184,0x186,0x187,0x188,0x18a,
0x18c,0x18e,0x18f,0x190,0x191,0x192,
0x193,0x195,0x197,0x198,0x199,0x19a,0x19b,
0x19c,0x19f,0x1a0,0x1a1,
0x1a2,0x1a3,0x1a4,0x1a5,
0x1a6,0x1ab,0x1b0,0x1b8}

pole_player = {0xa2,0xa4,0xa6,0xaa,0xab,0xac,0xed,
0xae,0xb0,0xb1,0xb3,0xb4,0xb6,0xb8,
0xb9,0xba,0xbb,0xbd,0xbe,0xa3,0xA5,0xB2,0xB5,0xBF}

misc_player = {0x01,0x03,0x05,0x07,0x09,0x32,0x33,0x34,0x35,0x36,0x37,
0x42,0x43,0x44,0x45,0x11,0x121,0x129,0x13,0x141,0x143,
0x149,0x14b,0x151,0x153,0x15,0x177,0x17f,
0x17,0x19,0x1b3,0x1b5,0x1b7,0x1bb,
0x1bd,0x1bf,0x1b,0x1d,0x1f1,0x1f9,0x1fb,0x1f,
0x3b,0x3d,0x3f,0x4d,0x51,0x55,0x59,0x5b,0x5d,0x89,0x8b,0x129,
0x141,0x121,0x129,0x89,0x151,0x153,0x149,0x143}

def get_sprite_names():

    rval = dict()
    rval |= {k:"player" for k in player_sprite_pairs | player_single_sprites}
    rval |= {k:"weight_player" for k in weight_player}
    rval |= {k:"misc_player" for k in misc_player}
    rval |= {k:"pole_player" for k in pole_player}
    rval |= {k:"swimming_player" for k in swimming_player}
    rval |= {k:"shooting_player" for k in shooting_player}
    rval |= {k:"running_player" for k in running_player}
    rval |= {k:"bow_player" for k in bow_player}
    rval[0x15E] = "apple"
    rval[0x105] = "water"
    rval[0x1E6] = "gun"
    rval[0x6C] = "referee"
    rval |= {k:"girl" for k in girls}
    rval |= {k:"butterfly" for k in range(0x1FD,0x200)}
    rval |= {k:"frog" for k in range(0xE9,0xEC)}
    rval |= {k:"pole" for k in range(0xE1,0xE7)}
    rval |= {k:"mole" for k in range(0x20,0x29)}
    rval |= {k:"shooting_player" for k in range(0x1E1,0x1EF,2)}
    rval |= {k:"running_player" for k in range(0xC1,0xE0,2)}
    rval |= {k:"running_player" for k in range(0xB,0x10,2)}
    rval[0xFC] = "frame"
    rval[0xEC] = "points_3000"
    rval[0xF0] = "points_1000"
    rval[0x14C] = "skeet"
    rval[0x15F] = "skeet"
    rval[0x17A] = "breath"
    rval[0x145] = "sights"
    rval[0x6D] = "referee"
    rval[0x1F6] = "easter_spaceship"
    rval[0x1EE] = "go"
    rval[0x1DE] = "ship_3000"
    rval[0x163] = "points_1000_2000"
    rval[0x1F7] = "points_3000"
    rval[0x17C] = rval[0x17D] = "nice"
    rval[0x27] = "mark"
    rval[0x16A] = "points"
    rval[0x2A] = "shadow"
    rval[0x2C] = "shadow"
    rval[0x2E] = "shadow"
    rval[0x1a8] = "weight"
    rval[0x1aa] = "weight"
    rval[0x146] = rval[0x99] = "target"
    rval[0x147] = "target"
    rval[0x14e] = "target"
    rval[0x91] = "target"
    rval[0x31] = "caret"
    rval[0x6a] = "referee"
    rval[0x6b] = "referee"
    rval[0x68] = "referee"
    rval[0x69] = "referee"
    rval[0xE8] = "arrow"


    return rval

def get_mirror_sprites():
    """ return the index of the sprites that need mirroring
as opposed to Gyruss, most of the sprites don't

"""
    rval = ({0XFE,0xFF,0xF6,0xF7,  # player pounding the ground, sometimes inverted
    0X25,0X26,0X28,  # mole
    0x56,0x5E,0x42,0x4A,0x1A1,0x1A3,0x1A4,0x1A5,0x1A6,0x1E6,0x1EE,0X138,0X1AC,0X110,0X130,0X124,0X12C,0X13C,
    0X134,0X113,0x103,0X107,0x1AE,0x145,0x111,0x146,0x14E,0xE1,0xE2,0xE3,0xE4,0xE5,0x6E,0x83,0x82,0x94,0x9C} | sr2(0x102,0x10A)|
    sr2(0x114,0x120)  # swimmers
    )
    return rval

alphanum_tile_codes = set(range(0,10)) | set(range(65-48,65+27-48))

if __name__ == "__main__":
    raise Exception("no main!")